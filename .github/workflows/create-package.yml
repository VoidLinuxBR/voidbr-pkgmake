name: Build with voidbr-pkgmake

on:
  push:
    branches: ["main"]
  pull_request:

  workflow_dispatch: # Permite a execução manual do workflow
    inputs:
      tmate: # Input para habilitar o modo de depuração
        type: boolean
        description: "With TMATE"
        required: false
        default: false
      packager:
        type: string
        description: "Empacotador"
        required: true
        default: "Vilmar Catafesta <vcatafesta@gmail.com>"

  #  schedule:  # Executa automaticamente toda sexta-feira às 05:00
  #    - cron: '0 5 * * 5'

  repository_dispatch: # Permite a execução através de eventos de webhook
    types:
      - webhook
      - "**"

env:
  PKGMAKE_PRIVATE_KEY: "${{ secrets.PKGMAKE_PRIVATE_KEY }}"
  PKGMAKE_PACKAGER: "${{ github.event.client_payload.packager || inputs.packager || 'Vilmar Catafesta <vvcatafesta@gmail.com>' }}"
  DEBUG: "${{ github.event.client_payload.tmate || inputs.tmate || true }}"

jobs:
  build:
    runs-on: ubuntu-latest
    #runs-on: self-hosted
    env:
      #DEBUG: false
      TERM: xterm
    # 2. Subir container VoidLinux e instalar tmate
    container:
      image: vcatafesta/voidlinux-docker:1.5 #seg 16 fev 2026 23:52:08 -04
      options: -v ${{ github.workspace }}:/workspace --privileged
    steps:
      - name: update
        run: |
          xbps-install -Syu xbps
          xbps-install --update --yes voidbr-pkgmake tmate openssh git
          vinstall -Scc

      # 3. Iniciar sessão tmate imediatamente dentro do container
      - name: Setup TMATE Session in CONTAINER
        uses: mxschmitt/action-tmate@v3
        if: ${{ env.DEBUG == 'true' }}
        with:
          install-dependencies: false
          detached: true

      - name: Checkout do repositório atual
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Checkout de outro repositório
        uses: actions/checkout@v4
        with:
          repository: vcatafesta/gitrepo
          fetch-depth: 1
          path: gitrepo

      - name: Create private.pem
        shell: bash
        run: |
          rm -rf "$HOME/.ssh"
          mkdir -p "$HOME/.ssh"

          {
            echo "Host repo"
            echo "  HostName ${{ secrets.SERVER_HOST }}"
            echo "  Port ${{ secrets.SERVER_PORT }}"
            echo "  User ${{ secrets.SERVER_USER }}"
            echo "  IdentityFile ~/.ssh/id_rsa"
            echo "  IdentitiesOnly yes"
          ) > $HOME/.ssh/config

          echo "$PKGMAKE_PRIVATE_KEY" > "$HOME/.ssh/private.pem"
          echo "$PKGMAKE_PRIVATE_KEY" > "$HOME/.ssh/privkey.pem"
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > "$HOME/.ssh/id_rsa"

          chmod 700 "$HOME/.ssh"
          chmod 600 "$HOME/.ssh/private.pem"
          chmod 600 "$HOME/.ssh/privkey.pem"
          chmod 600 "$HOME/.ssh/id_rsa"

          ssh-keygen -y -f "$HOME/.ssh/id_rsa" > "$HOME/.ssh/id_rsa.pub" || true
          ssh-keygen -l -f "$HOME/.ssh/id_rsa" || true

          touch "$HOME/.ssh/known_hosts"

          ssh-keyscan -p "${{ secrets.SERVER_PORT }}"      -H "${{ secrets.SERVER_HOST }}"      >> "$HOME/.ssh/known_hosts" 2>/dev/null || true
          ssh-keyscan -p "${{ secrets.TS_VOIDREPO_PORT }}" -H "${{ secrets.TS_VOIDREPO_HOST }}" >> "$HOME/.ssh/known_hosts" 2>/dev/null || true

      - name: Create .chili-make-repo.conf
        shell: bash
        run: |
          {
            echo "[void]"
            echo "GPGKEY=A0D5A8312A83940ED8B04B0F4BAC871802E960F1"
            echo "SECRETKEY=lg63771588@"
            echo "local_PATH=$HOME/repodir"
            echo "remote_HOST=${{ secrets.SERVER_HOST }}"
            echo "remote_USER=${{ secrets.SERVER_USER }}"
            echo "remote_PATH=/home/${{ secrets.SERVER_USER }}/domains/chililinux.com/public_html/void/current"
            echo "remote_PORT=${{ secrets.SERVER_PORT }}"
            echo "PACKAGER='Vilmar Catafesta <gmail.com>'"
            echo "prefix_DB=void"
          } > $HOME/.chili-make-repo.conf

      - name: Build pkg
        shell: bash
        run: |
          cd gitrepo/pkgfile
          if pkgmake -s --packager "$PKGMAKE_PACKAGER"; then
            chili-make-repo -A void
          fi
