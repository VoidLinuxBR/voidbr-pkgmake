name: Build with voidbr-pkgmake

on:
  #  push:
  #    branches: ["main"]
  pull_request:

  workflow_dispatch: # Permite a execução manual do workflow
    inputs:
      tmate: # Input para habilitar o modo de depuração
        type: boolean
        description: "With TMATE"
        required: false
        default: true
      packager:
        type: string
        description: "Empacotador"
        required: true
        default: "Vilmar Catafesta <vcatafesta@gmail.com>"
      package:
        type: string
        description: "Pacote para construir"
        required: true
      repository:
        type: string
        description: "Repositorio para construir"
        required: true

  #  schedule:  # Executa automaticamente toda sexta-feira às 05:00
  #    - cron: '0 5 * * 5'

  repository_dispatch: # Permite a execução através de eventos de webhook
    types:
      - webhook
      - "**"

env:
  SSH_PRIVATE_KEY: "${{ secrets.SSH_PRIVATE_KEY }}"
  SERVER_HOST: "${{ secrets.SERVER_HOST }}"
  SERVER_USER: "${{ secrets.SERVER_USER }}"
  SERVER_PORT: "${{ secrets.SERVER_PORT }}"
  TS_VOIDREPO_HOST: "${{ secrets.TS_VOIDREPO_HOST }}"
  TS_VOIDREPO_PORT: "${{ secrets.TS_VOIDREPO_PORT }}"
  PKGMAKE_PRIVATE_KEY: "${{ secrets.PKGMAKE_PRIVATE_KEY }}"
  PKGMAKE_PACKAGER: "${{ github.event.client_payload.packager || inputs.packager || 'Vilmar Catafesta <vvcatafesta@gmail.com>' }}"
  DEBUG: "${{ github.event.client_payload.tmate || inputs.tmate || true }}"

jobs:
  build:
    #runs-on: ubuntu-latest
    runs-on: self-hosted
    env:
      #DEBUG: false
      TERM: xterm
    # 2. Subir container VoidLinux e instalar tmate
    container:
      image: vcatafesta/voidlinux-docker:1.5 #seg 16 fev 2026 23:52:08 -04
      options: -v ${{ github.workspace }}:/workspace --privileged
    steps:
      - name: update
        run: |
          xbps-install -Syu xbps
          xbps-install --update --yes voidbr-pkgmake void-utils tmate openssh git
          vinstall -Scc

      # 3. Iniciar sessão tmate imediatamente dentro do container
      - name: Setup TMATE Session in CONTAINER
        uses: mxschmitt/action-tmate@v3
        if: ${{ env.DEBUG == 'true' }}
        with:
          install-dependencies: false
          detached: true

      - name: Checkout do repositório atual
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Checkout do pacote recebido
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.client_payload.repository }}
          token: ${{ secrets.ORGANIZATION_TOKEN }}
          fetch-depth: 1
          path: pkgmake

      - name: Create private.pem
        shell: bash
        run: |
          cpath=('/root', "$HOME")
          for cdir in "${cpath[@]}"; do
            rm -rf "$cdir/.ssh"
            mkdir -p "$cdir/.ssh"

            {
              echo "Host repo"
              echo "  HostName $SERVER_HOST"
              echo "  Port $SERVER_PORT"
              echo "  User $SERVER_USER"
              echo "  IdentityFile ~/.ssh/id_rsa"
              echo "  IdentitiesOnly yes"
            }  > "$cdir/.ssh/config"

            echo "$PKGMAKE_PRIVATE_KEY" > "$cdir/.ssh/private.pem"
            echo "$PKGMAKE_PRIVATE_KEY" > "$cdir/.ssh/privkey.pem"
            printf '%s\n' "$SSH_PRIVATE_KEY" > "$cdir/.ssh/id_rsa"
            chmod 700 "$cdir/.ssh"
            chmod 600 "$cdir/.ssh/private.pem"
            chmod 600 "$cdir/.ssh/privkey.pem"
            chmod 600 "$cdir/.ssh/id_rsa"
            ssh-keygen -y -f "$cdir/.ssh/id_rsa" > "$cdir/.ssh/id_rsa.pub" || true
            touch "$cdir/.ssh/known_hosts"
            ssh-keyscan -p "$TS_VOIDREPO_PORT" -H "$TS_VOIDREPO_HOST" >> "$cdir/.ssh/known_hosts" 2>/dev/null || true
            ssh-keyscan -p "$SERVER_PORT"      -H "$SERVER_HOST"      >> "$cdir/.ssh/known_hosts" 2>/dev/null || true
          done

      - name: Create .chili-make-repo.conf
        shell: bash
        run: |
          cpath=('/root', "$HOME")
          for cdir in "${cpath[@]}"; do
            {
              echo "[void]"
              echo "GPGKEY=A0D5A8312A83940ED8B04B0F4BAC871802E960F1"
              echo "SECRETKEY=lg63771588@"
              echo "local_PATH=$HOME/repodir"
              echo "remote_HOST=$SERVER_HOST"
              echo "remote_USER=$SERVER_USER"
              echo "remote_PATH=/home/$SERVER_USER/domains/chililinux.com/public_html/void/current"
              echo "remote_PORT=$SERVER_PORT"
              echo "PACKAGER='Vilmar Catafesta <gmail.com>'"
              echo "prefix_DB=void"
            } > "$cdir/.chili-make-repo.conf"
          done

      - name: Build pkg
        shell: bash
        run: |
          cd pkgmake/pkgfile
          pkgmake -s --packager "$PKGMAKE_PACKAGER"

      - name: Atualizar pacote no repositorio
        shell: bash
        run: |
          chili-make-repo -A void
