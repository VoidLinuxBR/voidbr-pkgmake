# Maintainer: Robson Nakane <theblizzard@hotmail.com>

pkgbase=zashterminal
pkgname=voidbr-zashterminal
pkgver=$(date +%Y%m%d)
pkgrel=$(date +%H%M)
pkgdesc="A modern GTK4/Adwaita terminal emulator with advanced session management, SSH integration, and security features."
arch=('any')
url="https://github.com/leoberbert/zashterminal"
license=('GPL3')
depends=(python3 python3-pip git rsync sshpass gettext gtk4 libadwaita vte3-gtk4 libsecret gobject-introspection python3-gobject python3-cairo python3-requests python3-psutil python3-Pygments)
makedepends=(uv python3-regex python3-py7zr python3-setproctitle python3-cryptography)
#source=("git+${url}.git")
source=("${pkgbase}::git+${url}.git")
sha256sums=('SKIP')

build() {
	cd "${srcdir}/$pkgbase"
	find locale -name '*.po' -print0 | while IFS= read -r -d '' po; do
		lang=$(basename "${po%.po}")
		out="usr/share/locale/${lang}/LC_MESSAGES/zashterminal.mo"
		mkdir -p "$(dirname "$out")"
		msgfmt -o "$out" "$po"
	done
	uv build --wheel
}

package() {
	local dirs=("usr" "etc" "opt")
	cd "${srcdir}/$pkgbase"

	python -m installer --destdir="$pkgdir" dist/*.whl

	if [ -d "usr/share" ]; then
		mkdir -p "$pkgdir/usr"
		cp -ra usr/share "$pkgdir/usr/"
	fi

	for dir in "${dirs[@]}"; do
		if [ -d "${_pkgsrc}/${dir}" ]; then
			cp -a "${_pkgsrc}/${dir}" "$DESTDIR/"
		fi
	done

	install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
	install -Dm644 README.md "$pkgdir/usr/share/doc/$pkgname/README.md"
}

post_install() {
	PACKAGE_NAME="zashterminal"
	DESKTOP_ID="org.leoberbert.zashterminal"
	REPO_URL="https://github.com/leoberbert/zashterminal.git"
	INSTALL_ROOT="/opt/${PACKAGE_NAME}"
	VENV_DIR="${INSTALL_ROOT}/venv"
	BIN_PATH="/usr/local/bin/${PACKAGE_NAME}"
	APP_DIR="/usr/share/applications"
	ICON_DIR="/usr/share/icons/hicolor/scalable/apps"
	PIXMAP_DIR="/usr/share/pixmaps"
	LOCALE_BASE_DIR="/usr/share/locale"

	log() {
		echo "[$(date +%H:%M:%S)] $*"
	}

	warn() {
		echo "[$(date +%H:%M:%S)] WARNING: $*" >&2
	}

	die() {
		echo "[$(date +%H:%M:%S)] ERROR: $*" >&2
		exit 1
	}

	require_cmd() {
		command -v "$1" >/dev/null 2>&1 || die "Required command not found: $1"
	}

	python_cmd() {
		if command -v python3 >/dev/null 2>&1; then
			echo python3
		else
			echo python
		fi
	}

	prepare_source() {

		script_dir=$(pwd)

		if [ -f "${script_dir}/pyproject.toml" ] &&
			[ -d "${script_dir}/src/zashterminal" ]; then
			echo "$script_dir"
			return
		fi

		require_cmd git
		tmp_dir=$(mktemp -d)
		log "Cloning source..."
		git clone --depth 1 "$REPO_URL" "${tmp_dir}/${PACKAGE_NAME}" >/dev/null || die "Git clone failed"

		echo "${tmp_dir}/${PACKAGE_NAME}"
	}

	install_python_app() {
		src_dir="$1"
		pybin=$(python_cmd)

		log "Creating venv..."
		mkdir -p "${INSTALL_ROOT}"
		rm -rf "${VENV_DIR}"

		"$pybin" -m venv --system-site-packages "${VENV_DIR}" || die "Venv creation failed"

		"${VENV_DIR}/bin/python" -m pip install --upgrade pip >/dev/null || warn "pip upgrade failed"

		"${VENV_DIR}/bin/python" -m pip install --no-deps "${src_dir}" >/dev/null || die "App install failed"

		"${VENV_DIR}/bin/python" -m pip install \
			requests psutil regex Pygments cryptography py7zr setproctitle \
			>/dev/null || warn "Some python deps failed"
	}

	install_launcher() {
		log "Installing launcher..."

		mkdir -p "$(dirname "${BIN_PATH}")"

		cat >"${BIN_PATH}" <<EOF
#!/bin/sh
exec "${VENV_DIR}/bin/${PACKAGE_NAME}" "\$@"
EOF
		chmod +x "${BIN_PATH}"
	}

	install_desktop_files() {
		src_dir="$1"

		mkdir -p "${APP_DIR}" "${ICON_DIR}" "${PIXMAP_DIR}"

		if [ -f "${src_dir}/usr/share/applications/${DESKTOP_ID}.desktop" ]; then
			install -Dm644 \
				"${src_dir}/usr/share/applications/${DESKTOP_ID}.desktop" \
				"${APP_DIR}/${DESKTOP_ID}.desktop"
		fi

		if [ -f "${src_dir}/usr/share/icons/hicolor/scalable/apps/${PACKAGE_NAME}.svg" ]; then
			install -Dm644 \
				"${src_dir}/usr/share/icons/hicolor/scalable/apps/${PACKAGE_NAME}.svg" \
				"${ICON_DIR}/${PACKAGE_NAME}.svg"

			install -Dm644 \
				"${src_dir}/usr/share/icons/hicolor/scalable/apps/${PACKAGE_NAME}.svg" \
				"${PIXMAP_DIR}/${PACKAGE_NAME}.svg"
		fi

		if command -v update-desktop-database >/dev/null 2>&1; then
			update-desktop-database "${APP_DIR}" >/dev/null 2>&1 || true
		fi

		if command -v gtk-update-icon-cache >/dev/null 2>&1; then
			gtk-update-icon-cache /usr/share/icons/hicolor >/dev/null 2>&1 || true
		fi
	}

	log "Starting installation..."

	require_cmd python3

	src_dir=$(prepare_source)
	install_python_app "${src_dir}"
	install_launcher
	install_desktop_files "${src_dir}"

	log "Installation complete."
}
